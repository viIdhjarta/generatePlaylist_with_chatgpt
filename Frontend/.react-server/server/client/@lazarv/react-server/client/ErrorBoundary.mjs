import{jsxs as f,jsx as d,Fragment as B}from"react/jsx-runtime";import{createContext as g,useContext as h,useState as C,useMemo as x,Component as R,createElement as S,isValidElement as v,useEffect as w}from"react";import{FlightContext as y,FlightComponentContext as T,useClient as p,PAGE_ROOT as b}from"./context.mjs";const E=g(null);function P(){const t=h(E),[e,r]=C({error:null,hasError:!1}),o=x(()=>({resetBoundary:()=>{t.resetErrorBoundary(),r({error:null,hasError:!1})},showBoundary:n=>r({error:n,hasError:!0})}),[t.resetErrorBoundary]);if(e.hasError)throw e.error;return o}const c={didCatch:!1,error:null};class k extends R{constructor(e){super(e),this.resetErrorBoundary=this.resetErrorBoundary.bind(this),this.state=c}static getDerivedStateFromError(e){return{didCatch:!0,error:e}}async resetErrorBoundary(...e){const{error:r}=this.state;r!==null&&(await this.props.onReset?.({args:e,reason:"imperative-api",error:r,resetErrorBoundary:this.resetErrorBoundary}),typeof r?.digest!="string"&&this.setState(c))}componentDidCatch(e,r){this.props.onError?.(e,r)}componentDidUpdate(e,r){const{didCatch:o}=this.state,{resetKeys:n}=this.props;if(o&&r.error!==null&&K(e.resetKeys,n))if(typeof this.props.onReset=="function"){const a=this.props.onReset({next:n,prev:e.resetKeys,reason:"keys"});typeof a?.then=="function"?a.then(()=>{this.setState(c)}):this.setState(c)}else this.setState(c)}render(){const{children:e,fallbackRender:r,FallbackComponent:o,fallback:n}=this.props,{didCatch:a,error:s}=this.state;s?.message==="Redirect"&&s?.digest.startsWith("Location=")&&(s.redirectTo=s.digest.slice(9));let i=e;if(a){const u={error:s,resetErrorBoundary:this.resetErrorBoundary};if(delete s.stack,typeof r=="function")i=r(u);else if(o)i=S(o,u);else if(n===null||v(n))i=n;else throw s}return d(E.Provider,{value:{didCatch:a,error:s,resetErrorBoundary:this.resetErrorBoundary},children:i})}}function K(t=[],e=[]){return t.length!==e.length||t.some((r,o)=>!Object.is(r,e[o]))}function O({FallbackComponent:t,fallbackRender:e,...r}){const{outlet:o}=h(y),n=p(),{navigate:a}=n,{error:s}=r,{redirectTo:i}=s;return w(()=>{i&&a(i,{outlet:o,external:o!==b})},[i,a,o]),i?null:f(B,{children:[t&&typeof t=="function"?d(t,{...r}):t,e?.(r)]})}function j({error:t}){if(t)throw t;return null}function _({component:t,render:e,onReset:r,global:o,children:n,...a}){const{outlet:s}=h(y),{resourceKey:i,error:u}=h(T),{invalidate:m}=p();return f(k,{...a,onReset:async l=>{typeof l.error?.digest=="string"&&await m(s),r?.(l)},fallbackRender:l=>d(O,{FallbackComponent:t,fallbackRender:e,...l}),children:[d(j,{error:u}),n]},`${s}_${i}`)}export{k as ErrorBoundary,_ as default,P as useErrorBoundary};
